<div class="container mt-4">
    <h2>Gestión de Reservas</h2>

    <!-- Mensajes de error -->
    <div *ngIf="errorMessage" class="alert alert-danger alert-dismissible fade show" role="alert">
        {{errorMessage}}
        <button type="button" class="btn-close" (click)="errorMessage = ''"></button>
    </div>

    <!-- Mensajes de éxito -->
    <div *ngIf="successMessage" class="alert alert-success alert-dismissible fade show" role="alert">
        {{successMessage}}
        <button type="button" class="btn-close" (click)="successMessage = ''"></button>
    </div>

    <!-- Mensaje de alerta para ciudades iguales -->
    <div *ngIf="ciudadesIguales" class="alert alert-warning alert-dismissible fade show" role="alert">
        No se puede seleccionar la misma ciudad como origen y destino
        <button type="button" class="btn-close" (click)="ciudadesIguales = false"></button>
    </div>

    <form [formGroup]="reservaForm" (ngSubmit)="onSubmit()" class="mt-4">
        <!-- Bloque de datos del cliente -->
        <div class="card mb-4 p-3 shadow-sm">
            <h5 class="mb-3">Datos del Cliente</h5>
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <mat-form-field appearance="fill" class="w-100">
                        <mat-label>Cédula*</mat-label>
                        <input type="text"
                               matInput
                               placeholder="Cédula*"
                               formControlName="documento"
                               [matAutocomplete]="auto">
                        <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onClienteSelected($event.option.value)">
                            <mat-option *ngFor="let cliente of filteredClientes$ | async" [value]="cliente">
                                {{ cliente.documento }} - {{ cliente.nombre }}
                            </mat-option>
                        </mat-autocomplete>
                    </mat-form-field>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="nombre">Nombre*</label>
                        <input type="text" class="form-control" id="nombre" formControlName="nombre" [readonly]="clienteExistente">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="form-group">
                        <label for="fecha_nacimiento">Fecha de Nacimiento*</label>
                        <input type="date" class="form-control" id="fecha_nacimiento" formControlName="fecha_nacimiento" [readonly]="clienteExistente">
                    </div>
                </div>
            </div>
            <div class="row g-3 align-items-center mt-2">
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="telefono">Teléfono*</label>
                        <input type="text" class="form-control" id="telefono" formControlName="telefono" [readonly]="clienteExistente">
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <label for="email">Email*</label>
                        <input type="email" class="form-control" id="email" formControlName="email" [readonly]="clienteExistente">
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="fecha_vuelos">Fecha de Vuelo</label>
                    <input type="date" class="form-control" id="fecha_vuelos" formControlName="fecha_vuelos">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Hora</mat-label>
                        <input matInput 
                               type="time" 
                               formControlName="hora" 
                               placeholder="Seleccione la hora">
                        <mat-icon matSuffix>access_time</mat-icon>
                    </mat-form-field>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="aerolinea_id">Aerolínea</label>
                    <select class="form-control" id="aerolinea_id" formControlName="aerolinea_id">
                        <option value="">Seleccione una aerolínea</option>
                        <option *ngFor="let aerolinea of aerolineas" [value]="aerolinea.id">
                            {{aerolinea.nombre}}
                        </option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="origen_id">Ciudad Origen</label>
                    <select class="form-control" id="origen_id" formControlName="origen_id">
                        <option value="">Seleccione una ciudad</option>
                        <option *ngFor="let ciudad of ciudades" [value]="ciudad.id">
                            {{ciudad.nombre}}
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="destino_id">Ciudad Destino</label>
                    <select class="form-control" id="destino_id" formControlName="destino_id">
                        <option value="">Seleccione una ciudad</option>
                        <option *ngFor="let ciudad of ciudades" [value]="ciudad.id">
                            {{ciudad.nombre}}
                        </option>
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="moneda_id">Moneda</label>
                    <select class="form-control" id="moneda_id" formControlName="moneda_id">
                        <option value="">Seleccione moneda</option>
                        <option *ngFor="let moneda of monedas" [value]="moneda.id">
                            {{moneda.tipo_moneda}}
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-4">
                <div class="form-group">
                    <label for="tipo_pago_id">Tipo de Pago</label>
                    <select class="form-control" id="tipo_pago_id" formControlName="tipo_pago_id">
                        <option value="">Seleccione tipo de pago</option>
                        <option *ngFor="let tipoPago of tiposPago" [value]="tipoPago.id">
                            {{tipoPago.medio_pago}}
                        </option>
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label for="numero_vuelos">Número de Vuelos</label>
                    <input type="number" class="form-control" id="numero_vuelos" formControlName="numero_vuelos">
                </div>
            </div>
        </div>

        <div class="row mt-3">
            <div class="col-md-6">
                <div class="form-group">
                    <label for="valor">Valor</label>
                    <input type="number" class="form-control" id="valor" formControlName="valor">
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label for="valor_equipaje">Valor Equipaje</label>
                    <input type="number" class="form-control" id="valor_equipaje" formControlName="valor_equipaje">
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <button type="submit" class="btn btn-primary" [disabled]="!reservaForm.valid || ciudadesIguales">
                    {{ reservaForm.get('id')?.value ? 'Actualizar' : 'Crear' }} Reserva
                </button>
                <button type="button" class="btn btn-secondary ms-2" (click)="resetForm()">
                    Limpiar
                </button>
                <!-- Botón de depuración temporal -->
                <button type="button" class="btn btn-info ms-2" (click)="verificarEstadoFormulario()">
                    Verificar Estado (Depuración)
                </button>
            </div>
        </div>
    </form>
</div>
